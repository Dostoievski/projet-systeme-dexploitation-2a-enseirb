#include <pthread.h>
#include <stdio.h>
#include <stdlib.h>
#include <assert.h>
#include <sys/time.h>
#include "../../src/thread.h"

#define SIZE 1000

int TAB[SIZE];

int STO[SIZE/20];

double getTime(){
  struct timeval tv;
  gettimeofday(&tv,NULL);
  return 1000*tv.tv_sec+tv.tv_usec/1000.0;
}

static void* somme(void* a){
  int i;
  int z = *(int*)a;
  int tid = thread_self();
  STO[tid-1] = 0;
  for(i = z; i < z + 20 ; i++){
     STO[tid - 1] += TAB[i];
    thread_yield();
  } 
  printf("  SOMME T[%d...%d] = %d\n",z, z+99,*(STO + tid -1));
  thread_exit(STO + tid -1);
} 

int main(){
  int i;
  thread_t tid[SIZE/100];
  void* retVal[SIZE/100];
  int err, resultat = 0;
  int a;
  
  for(i = 0; i<SIZE ; i++){
    TAB[i] = i;
  }

  printf("Tableau T de taille %d\n", SIZE); 

  double t1 = getTime();
  for(i = 0; i<SIZE/100 ; i++){
    a = i*100;
    thread_create(tid+i,somme, (void*)&a);
  }

  for(i = 0; i<SIZE/100 ; i++){
    err = thread_join(tid[i], retVal+i);
    assert(!err);
    resultat += **((int**)(retVal+i));
  }
  double t2 = getTime();
  
  printf("      somme des elements = %d\n",resultat);
  printf("   [Cout de calcul = %g ms]\n", t2 - t1);
  return EXIT_SUCCESS;
}
