#include <stdlib.h>
#include <stdio.h>
#include <sys/time.h>

#include "../../src/thread.h"

//static int FIBO_SIZE;

static thread_t tid[1000];

static int fibtab[1000];

double getTime(){
  struct timeval tv;
  gettimeofday(&tv,NULL);
  return 1000*tv.tv_sec+tv.tv_usec/1000.0;
}

void* fibo (void * n){
  if(fibtab[*(int*)n]  != -1){
    printf("!= %d *******  %d\n",fibtab[*(int*)n], *(int*)n);
    thread_exit(fibtab + *(int*)n);
  }
  else{
    printf("== %d *******  %d\n",fibtab[*(int*)n],*(int*)n);
    void *retval1; void* retval2;
    int a = *(int*)n - 1;
    int b = *(int*)n - 2;
    thread_t t = thread_self();
    
    
    thread_create(tid + t, (void *(*)(void *)) fibo, &a);
    thread_join(*(tid + t), &retval1);
    /*if(fibtab[b]  != -1){
      thread_create(tid + t + 1, (void *(*)(void *))fibo, &b);
      thread_join(*(tid + t +1), &retval2);
      }*/
    
    fibtab[*(int*)n] = *(int*)retval1 ;//+ *(int*)retval2;
    
    //printf("FIBO[%d] = %d\n",b,*(int*)retval2);
    printf("FIBO[%d] = %d\n",a,*(int*)retval1);
    
    thread_exit(fibtab + *(int*)n);
  }
}

int main(){
  int FIBO_SIZE;
  printf("Entrer un entier: \n");
  scanf("%d",&FIBO_SIZE);
  //fibtab = (double*)malloc(sizeof(double) * (FIBO_SIZE + 1));
  //tid = (thread_t*)malloc(sizeof(thread_t) * (FIBO_SIZE + 1));
  
  printf("\n.......Calcul de FIBO(%d) ..... \n",FIBO_SIZE); 

  /* On initialise le tableau */
  
  if(FIBO_SIZE == 0)
    fibtab[0] = 0;
  if(FIBO_SIZE > 0){
    fibtab[0] = 0;
    fibtab[1] = 1;
    int i;
    for(i = 2; i < FIBO_SIZE + 10; i++){
      fibtab[i] = -1;
    }
  }
  int i;
  for(i = 0; i < FIBO_SIZE + 10; i++){
    printf("element = %d\n",fibtab[i]);
  }
  /* On calcule fibo(n) */
  int * resultat;
  double t1 = getTime();
  thread_create(tid,fibo,(void *)&FIBO_SIZE);
  thread_join(*tid , (void**)&resultat);
  double t2 = getTime();

  /* On affiche le rÃ©sultat */
  printf(".......Resultat FIBO[%d] = %d\n",FIBO_SIZE,*resultat);
  printf("   [Cout de calcul = %g ms]\n", t2 - t1);
  //free(fibtab);
  //free(tid);
  return EXIT_SUCCESS; 
}
