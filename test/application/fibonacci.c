#include <stdlib.h>
#include <stdio.h>
#include <unistd.h>

#include "../../src/thread.h"

static int FIBO_SIZE;

static thread_t tid[FIBO_SIZE];

long long fibtab[FIBO_SIZE];

void* fibo (void * n){
  if(fibtab[*(int*)n] != -1)
    thread_exit(fibtab + n);
  void *retval1; void* retval2;
  int a = *(int*)n - 1;
  int b = *(int*)n - 2;
  thread_t t = thread_self();
  
  thread_create(tid + t, (void *(*)(void *)) fibo, &a);
  thread_create(tid + t + 1, (void *(*)(void *))fibo, &b);
  thread_join(*(tid + t), &retval1);
  thread_join(*(tid + t + 1), &retval2);
  
  fiftab[n] = *(int*)retval1 + *(int*)retval2;
  
  printf("FIBO[%d] = %d\n",a,*(int*)retval1);
  printf("FIBO[%d] = %d\n",b,*(int*)retval2);
  
  thread_exit(fibtab + n);
}

int main(){
  int i;
  long long* resultat;
  printf("Entrer un entier: \n");
  scanf("%d",&FIBO_SIZE);
  printf("\n.......Calcul de FIBO(%d) ..... \n",FIBO_SIZE); 

  /* On initialise le tableau */
  fibtab[0]=0;
  fibtab[1]=1;
  for(i=2 ; i<FIBO_SIZE ; i++)
    fibtab[i]=-1;
  
  /* On calcule fibo(n) */
  double t1 = getTime();
  thread_create(tid,fibo,(void *)FIBO_SIZE);
  thread_join(*tid , &resultat);
  double t1 = getTime();
  /* On affiche le rÃ©sultat */
  printf(".......Resultat FIBO[%d] = %ld\n",FIBO_SIZE,*resultat);
  printf("   [Cout de calcul = %g ms]\n", t2 - t1);
  return EXIT_SUCCESS; 
}
