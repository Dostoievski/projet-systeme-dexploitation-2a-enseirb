#include <stdlib.h>
#include <stdio.h>
#include <assert.h>
#include <ucontext.h>
#include "threadStructure.h"

static thread_t TID = 0;

static ucontext_t * current = mallocContext();

ucontext_t* mallocContext(){
  ucontext_t *uc = (ucontext_t*)malloc(sizeof(ucontext_t));
  return uc;
}

ucontext_t* createContext(void(*func)(void),void *funcarg){
  ucontext_t *uc = mallo cContext();
  ucontext_t *uc2 = mallocContext();
  getcontext(uc);
  getcontext(uc2);
  uc->uc_stack.ss_size = 64*1024;
  uc->uc_stack.ss_sp = malloc(uc->uc_stack.ss_size);
  if(!uc->uc_stack.ss_sp)
    return NULL;
  uc->uc_link = uc2;
  makecontext(uc,func, 1, funcarg);
  return uc;
}

thread * newThread(thread_t tid, ucontext_t * uc){
  thread * t = (thread *)malloc(sizeof(thread)); 
  if(t){
    t->tid = tid;
    t->state = uc;
    return t;
  }
  return NULL;
}

thread_t getTidThread (thread* th){
  return th->tid;
}

ucontext_t* getThreadState(thread* th){
  return th->state;
}

void killThread(thread * th){
  assert(th);
  if(th->state) 
    free(th->state);
  free(th);
}
  
/*
 * generation du TID unique d'un thread
 */

thread_t getNextTID(){
  return ++TID;
}
