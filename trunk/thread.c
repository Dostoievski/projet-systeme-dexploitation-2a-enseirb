#include <stdlib.h>
#include <stdio.h>
#include <assert.h>
#include <ucontext.h>
#include "threadStructure.h"
#include "fifoThread.h"
#include "thread.h"

fifoThread * fifo = NULL;

thread_t thread_self(void){
  return getTidThread(getHeadFifoThread(fifo));
}

int thread_create(thread_t*t,void*(*func)(void *),void*arg){
  thread * th;
  ucontext_t *uc = createContext((void (*) (void))func,arg);
  if(!uc)
    return -1;
  *t = getNextTID();
  th = newThread(*t, uc);
  if(!fifo)
    fifo = createFifoThread();
  enqueueFifoThread(fifo, th);
  swapcontext(uc->uc_link, uc);
  return 0;
}


int thread_yield(void){
  if(isEmptyFifo(fifo))
    return -1;
  if(hasMoreThanOneElement(fifo)){
    firstBecomesLast(fifo);
    thread * th = getHeadFifoThread(fifo);
    ucontext_t * uc = getThreadState(th);    
    setcontext(uc);
  }
  return 0;
}

int thread_join(thread_t thread, void **retval){
  struct thread * th = getThreadByTid(fifo,thread);
  if(!isTheHead(fifo, thread)){
    killThreadByTid(fifo,thread);
    addInFifoHead(fifo,th);
  }
  ucontext_t * uc1 = getThreadState(th);
  setcontext(uc1);
  //if(retval==NULL)
  return 0;
  //else
}

void thread_exit(void *retval){
  static int i = 0;
  printf("appel %d\n",++i);
}
