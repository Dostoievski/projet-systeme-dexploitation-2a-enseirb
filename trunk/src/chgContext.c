#include <pthread.h>
#include <stdio.h>
#include <assert.h>
#include <sys/time.h>
#include "thread.h"

double getTime(){
  struct timeval tv;
  gettimeofday(&tv,NULL);
  return 1000*tv.tv_sec+tv.tv_usec/1000.0;
}

static void* threadfunc(void* arg)
{
  char *name = arg;
  printf("je suis le thread %d, lancé avec l'argument %s\n",
	 thread_self(), name);
  double t1 = getTime();
  thread_yield();
  double t2 = getTime();
  printf("je suis encore le thread %d, lancé avec l'argument %s\n",
	 thread_self(), name);
  printf("cout de changement de contexte avec thread.h: %g\n", t2-t1);
  thread_exit(arg);
}

static void* pthreadfunc(void* arg)
{
  char *name = arg;
  printf("je suis le thread %d, lancé avec l'argument %s\n",
	 pthread_self(), name);
  double t1 = getTime();
  sched_yield();
  double t2 = getTime();
  printf("je suis encore le thread %d, lancé avec l'argument %s\n",
	 pthread_self(), name);
  printf("cout de changement de contexte avec thread.h: %g\n", t2-t1);
  pthread_exit(arg);
}

void test_thread(){
  thread_t thread1, thread2, thread3;
  int err;

  printf("test - Chnagement de contexte - thread.h ...\n");
  err = thread_create(&thread1, pthreadfunc, "thread1");
  assert(!err);
  err = thread_create(&thread2, pthreadfunc, "thread2");
  assert(!err);
  
  err = pthread_join(thread1, NULL);
  assert(!err);
  err = pthread_join(thread2, NULL);
  assert(!err);
}

void test_pthread(){
  thread_t thread1, thread2, thread3;
  int err;
  
  printf("test - Chnagement de contexte - Pthread.h ...\n");
  err = thread_create(&thread1, threadfunc, "thread1");
  assert(!err);
  err = thread_create(&thread2, threadfunc, "thread2");
  assert(!err);
  
  err = thread_join(thread1, NULL);
  assert(!err);
  err = thread_join(thread2, NULL);
  assert(!err);
}

int main(int argc, char *argv[])
{
  test_pthread();
  test_thread();
  return 0;
}
