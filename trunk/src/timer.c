#include <stdio.h>
#include <stdlib.h>

#ifdef O_PREEMPTION

#include <signal.h>
#include <sys/time.h>
#include <signal.h>
#include <time.h>
#include "thread.h"
 
static long GRANULARITE = 1;/*1ns par defaut*/

void handler(){
  thread_yield();
}

void setGranularite(long time){
  GRANULARITE = time;
}

long getGranularite(){
  return GRANULARITE;
}

void setTimer(){
  struct itimerspec value;
  timer_t my_timer;
  struct sigaction action;
  action.sa_flags = SA_SIGINFO;
  sigemptyset(&action.sa_mask);
  action.sa_sigaction = handler;
  value.it_value.tv_sec= 0;
  value.it_value.tv_nsec= 1;/*jamais mettre valeur nulle*/
  value.it_interval.tv_sec = 0;
  value.it_interval.tv_nsec = GRANULARITE;;
  sigaction(SIGALRM,action,NULL);
  timer_create(CLOCK_REALTIME,NULL,&my_timer);
  timer_settime(my_timer,0,&value,NULL);
}
#endif

void timer(void*(*func)(void*), void* arg){
#ifdef O_PREEMPTION
  setTimer();
#endif
  func(arg);
} 
