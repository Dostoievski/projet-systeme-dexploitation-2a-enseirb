#include <stdio.h>
#include <stdlib.h>
#include <pthread.h>
#include <time.h> //Ne pas oublier d'inclure le fichier time.h
#define SUP 10



void dump_tableau (int * T, int premier, int dernier) {
	fprintf(stderr,"Notre tableau  : \n  [");
  int i;
  for(i=premier;i<=dernier;i++){
    fprintf(stderr,"  %d  ",T[i]);
  }
  fprintf(stderr,"] \n");
}

void swap (int * T, int a, int b){
	int tmp;
	tmp = T[a];
	T[a] = T[b];
	T[b] = tmp;
}

int choix_pivot(int premier, int dernier){
	return (rand() % (dernier - premier)) + premier;	
}


int tri_pivot ( int * T, int premier,int dernier,int pivot){

	int post_arriere = dernier -1;
	//int post_avant = premier;
	swap(T,pivot, dernier);	
	
	int i;
	for(i = premier; (i < dernier) && (i <= post_arriere); i++) {
		if(T[i] >= T[dernier]){
			swap(T,i,post_arriere--);
			i--;
		}
	}
	swap(T,post_arriere + 1, dernier);
	
	
	//dump_tableau (T,dernier+1);
	//fprintf(stderr,"Il est maintenant en position : pivot T[%d] = %d \n", post_arriere + 1, T[post_arriere + 1]);
	
	return post_arriere + 1;
}


void tri_rapide (int ** arg){
	

	int premier,dernier;
	int * T;
	premier = *arg[0];
	dernier = *arg[1];	
	T = arg[2];
	int pivot;
	int tmp;
	 pthread_t thread_a;
	 pthread_t thread_b;
	
	fprintf(stderr,"\n \n FONCTION APPELE AVEC : \n");

	fprintf(stderr,"premier : %d et dernier %d \n",premier,dernier);
	dump_tableau (T,premier,dernier);
	fprintf(stderr,"\n \n FIN FONCTION APPELE AVEC : \n \n");

	if(premier < dernier){
		pivot = choix_pivot(premier,dernier);
		fprintf(stderr,"pivot choisi au hazard : %d \n", pivot);
		pivot = tri_pivot ( T, premier,dernier,pivot);
		
		dump_tableau (T,premier,dernier);
		fprintf(stderr,"Notre pivot T[%d] = %d \n",pivot, T[pivot]);

		tmp = pivot - 1;
		int * arg_a[3];
		arg_a[0] =  malloc(sizeof(int));
		*arg_a[0] = premier ;
		arg_a[1] =  malloc(sizeof(int));
		*arg_a[1] = tmp ;
		arg_a[2] =  T;
		

		
		pthread_create (&thread_a, NULL, (void *) &tri_rapide,(void *) arg_a);
	
		tmp = pivot + 1;
		int * arg_b[3];
		arg_b[0] =  malloc(sizeof(int));
		*arg_b[0] = tmp ;
		arg_b[1] =  malloc(sizeof(int));
		*arg_b[1] = dernier ;
		arg_b[2] =  T;
	
		
		pthread_create (&thread_b, NULL, (void *) &tri_rapide,(void *) arg_b);
		pthread_join(thread_b, NULL);
		pthread_join(thread_a, NULL);
		
		dump_tableau (T,premier,dernier);

		free(arg_b[0]);
		free(arg_b[1]);
		free(arg_a[0]);
		free(arg_a[1]);
		
		
		
	} else {
		fprintf(stderr,"recursion termine \n");	
	}
	
}

int main(){
	
  srand(time(NULL)); // initialisation de rand

  int T[SUP];
  int i;
  
  for(i=0;i<SUP;i++){
    T[i]=rand() %100;
  }
 	
  fprintf(stderr,"TABLEAU INITIAL : \n");
  
  dump_tableau (T,0,SUP-1);
  fprintf(stderr,"FIN TABLEAU INITIAL : \n");
  
  int premier = 0;
  int dernier = SUP - 1;
 
  pthread_t thread_a; 
  
  int * arg[3];
  arg[0] =  &premier;
  arg[1] =  &dernier;
  arg[2] =  T;
  
  pthread_create (&thread_a, NULL, (void *) &tri_rapide,(void *) arg);
  pthread_join(thread_a, NULL);
    
  return EXIT_SUCCESS;
}
